\hypertarget{run__loop__scheduler_8hpp_source}{}\doxysection{run\+\_\+loop\+\_\+scheduler.\+hpp}
\label{run__loop__scheduler_8hpp_source}\index{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp@{src/rpp/rpp/schedulers/run\_loop\_scheduler.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/schedulers/fwd.hpp>}                       \textcolor{comment}{// own forwarding}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/schedulers/details/worker.hpp>}            \textcolor{comment}{// worker}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/subscriptions/composite\_subscription.hpp>} \textcolor{comment}{// lifetime}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <rpp/schedulers/details/queue\_worker\_state.hpp>}\textcolor{comment}{// state}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{keyword}{namespace }rpp::schedulers}
\DoxyCodeLine{19 \{}
\DoxyCodeLine{23 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1schedulers_1_1details_1_1scheduler__tag}{details::scheduler\_tag}}}
\DoxyCodeLine{24 \{}
\DoxyCodeLine{25 \textcolor{keyword}{private}:}
\DoxyCodeLine{26     \textcolor{keyword}{class }state}
\DoxyCodeLine{27     \{}
\DoxyCodeLine{28     \textcolor{keyword}{public}:}
\DoxyCodeLine{29         state(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{30             : m\_sub\{sub\} \{ \}}
\DoxyCodeLine{31 }
\DoxyCodeLine{32         \string~state()}
\DoxyCodeLine{33         \{}
\DoxyCodeLine{34             m\_source.request\_stop();}
\DoxyCodeLine{35             m\_sub.unsubscribe();}
\DoxyCodeLine{36         \}}
\DoxyCodeLine{37 }
\DoxyCodeLine{38         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state}}\& get\_queue() \{ \textcolor{keywordflow}{return} m\_queue; \}}
\DoxyCodeLine{39         std::stop\_token              get\_token()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_source.get\_token(); \}}
\DoxyCodeLine{40 }
\DoxyCodeLine{41         \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& get\_subscription() \{ \textcolor{keywordflow}{return} m\_sub; \}}
\DoxyCodeLine{42     \textcolor{keyword}{private}:}
\DoxyCodeLine{43         \mbox{\hyperlink{classrpp_1_1composite__subscription}{rpp::composite\_subscription}} m\_sub;}
\DoxyCodeLine{44         \mbox{\hyperlink{classrpp_1_1schedulers_1_1details_1_1queue__worker__state}{details::queue\_worker\_state}} m\_queue\{\};}
\DoxyCodeLine{45         std::stop\_source            m\_source\{\};}
\DoxyCodeLine{46     \};}
\DoxyCodeLine{47 }
\DoxyCodeLine{48 \textcolor{keyword}{public}:}
\DoxyCodeLine{49     \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop_1_1worker__strategy}{worker\_strategy}}}
\DoxyCodeLine{50     \{}
\DoxyCodeLine{51     \textcolor{keyword}{public}:}
\DoxyCodeLine{52         \mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop_1_1worker__strategy}{worker\_strategy}}(\textcolor{keyword}{const} std::shared\_ptr<details::queue\_worker\_state>\& queue,}
\DoxyCodeLine{53                         \textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\&                       sub)}
\DoxyCodeLine{54             : m\_queue\{queue\}}
\DoxyCodeLine{55             , m\_sub\{sub\} \{ \}}
\DoxyCodeLine{56 }
\DoxyCodeLine{57         \textcolor{keywordtype}{void} defer\_at(time\_point time\_point, std::invocable \textcolor{keyword}{auto}\&\& fn)\textcolor{keyword}{ const}}
\DoxyCodeLine{58 \textcolor{keyword}{        }\{}
\DoxyCodeLine{59             \textcolor{keywordflow}{if} (m\_sub.\mbox{\hyperlink{classrpp_1_1subscription__base_ad9c07157024e7f68ce815d971c3faaf2}{is\_subscribed}}())}
\DoxyCodeLine{60                 m\_queue-\/>emplace(time\_point, std::forward<\textcolor{keyword}{decltype}(fn)>(fn));}
\DoxyCodeLine{61         \}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     \textcolor{keyword}{private}:}
\DoxyCodeLine{64         std::shared\_ptr<details::queue\_worker\_state> m\_queue\{\};}
\DoxyCodeLine{65         \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}                       m\_sub\{\};}
\DoxyCodeLine{66     \};}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \mbox{\hyperlink{classrpp_1_1schedulers_1_1run__loop}{run\_loop}}(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\})}
\DoxyCodeLine{69         : m\_state(std::make\_shared<state>(sub)) \{\}}
\DoxyCodeLine{70 }
\DoxyCodeLine{71     \textcolor{keyword}{auto} create\_worker(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\& sub = \mbox{\hyperlink{classrpp_1_1composite__subscription}{composite\_subscription}}\{\}) \textcolor{keyword}{const}}
\DoxyCodeLine{72     \{}
\DoxyCodeLine{73         \textcolor{keyword}{auto} res = m\_state-\/>get\_subscription().add(sub);}
\DoxyCodeLine{74         sub.add([weak = std::weak\_ptr\{m\_state\}, res]}
\DoxyCodeLine{75         \{}
\DoxyCodeLine{76             \textcolor{keywordflow}{if} (\textcolor{keyword}{const} \textcolor{keyword}{auto} sh = weak.lock())}
\DoxyCodeLine{77                 sh-\/>get\_subscription().remove(res);}
\DoxyCodeLine{78         \});}
\DoxyCodeLine{79         \textcolor{keywordflow}{return} worker<worker\_strategy>\{std::shared\_ptr<details::queue\_worker\_state>\{m\_state, \&m\_state-\/>get\_queue()\}, sub\};}
\DoxyCodeLine{80     \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82     \textcolor{keywordtype}{bool} is\_empty()\textcolor{keyword}{ const}}
\DoxyCodeLine{83 \textcolor{keyword}{    }\{}
\DoxyCodeLine{84         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_empty();}
\DoxyCodeLine{85     \}}
\DoxyCodeLine{86 }
\DoxyCodeLine{87     \textcolor{keywordtype}{bool} is\_any\_ready\_schedulable()\textcolor{keyword}{ const}}
\DoxyCodeLine{88 \textcolor{keyword}{    }\{}
\DoxyCodeLine{89         \textcolor{keywordflow}{return} m\_state-\/>get\_queue().is\_any\_ready\_schedulable();}
\DoxyCodeLine{90     \}}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     \textcolor{keywordtype}{void} dispatch\_if\_ready()\textcolor{keyword}{ const}}
\DoxyCodeLine{93 \textcolor{keyword}{    }\{}
\DoxyCodeLine{94         std::function<void()> fn\{\};}
\DoxyCodeLine{95         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_if\_ready(fn))}
\DoxyCodeLine{96             fn();}
\DoxyCodeLine{97     \}}
\DoxyCodeLine{98 }
\DoxyCodeLine{99     \textcolor{keywordtype}{void} dispatch()\textcolor{keyword}{ const}}
\DoxyCodeLine{100 \textcolor{keyword}{    }\{}
\DoxyCodeLine{101         std::function<void()> fn\{\};}
\DoxyCodeLine{102         \textcolor{keywordflow}{if} (m\_state-\/>get\_queue().pop\_with\_wait(fn, m\_state-\/>get\_token()))}
\DoxyCodeLine{103             fn();}
\DoxyCodeLine{104     \}}
\DoxyCodeLine{105 }
\DoxyCodeLine{106 \textcolor{keyword}{private}:}
\DoxyCodeLine{107     \textcolor{keyword}{const} std::shared\_ptr<state> m\_state\{\};}
\DoxyCodeLine{108 \};}
\DoxyCodeLine{109 \} \textcolor{comment}{// namespace rpp::schedulers}}

\end{DoxyCode}
