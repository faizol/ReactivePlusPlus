\hypertarget{subject__state_8hpp_source}{}\doxysection{subject\+\_\+state.\+hpp}
\label{subject__state_8hpp_source}\index{src/include/rpp/subjects/subject\_state.hpp@{src/include/rpp/subjects/subject\_state.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//                   ReactivePlusPlus library}}
\DoxyCodeLine{2 \textcolor{comment}{// }}
\DoxyCodeLine{3 \textcolor{comment}{//           Copyright Aleksey Loginov 2022 -\/ present.}}
\DoxyCodeLine{4 \textcolor{comment}{//  Distributed under the Boost Software License, Version 1.0.}}
\DoxyCodeLine{5 \textcolor{comment}{//     (See accompanying file LICENSE\_1\_0.txt or copy at}}
\DoxyCodeLine{6 \textcolor{comment}{//           https://www.boost.org/LICENSE\_1\_0.txt)}}
\DoxyCodeLine{7 \textcolor{comment}{// }}
\DoxyCodeLine{8 \textcolor{comment}{//  Project home: https://github.com/victimsnino/ReactivePlusPlus}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <rpp/subscribers/dynamic\_subscriber.hpp>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <rpp/utils/constraints.hpp>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <rpp/utils/utilities.hpp>}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <atomic>}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <functional>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{keyword}{namespace }rpp::subjects::details::states}
\DoxyCodeLine{22 \{}
\DoxyCodeLine{23 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{24 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}} : \textcolor{keyword}{public} std::enable\_shared\_from\_this<state\_interface<T>>}
\DoxyCodeLine{25 \{}
\DoxyCodeLine{26     \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}}() = \textcolor{keywordflow}{default};}
\DoxyCodeLine{27 }
\DoxyCodeLine{28     \textcolor{keyword}{virtual}                                        \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{\string~state\_interface}}() = \textcolor{keywordflow}{default};}
\DoxyCodeLine{29     \textcolor{keyword}{virtual} std::shared\_ptr<const state\_interface<T>> on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub) \textcolor{keyword}{const} = 0;}
\DoxyCodeLine{30     \textcolor{keyword}{virtual} std::shared\_ptr<const state\_interface<T>> on\_subscriber\_unsubscribed()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} this-\/>shared\_from\_this(); \}}
\DoxyCodeLine{31     \textcolor{keyword}{virtual} \textcolor{keywordtype}{bool} is\_terminated()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} \textcolor{keyword}{true}; \}}
\DoxyCodeLine{32 }
\DoxyCodeLine{33     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} on\_next(\textcolor{keyword}{const} T\&)\textcolor{keyword}{ const }\{\}}
\DoxyCodeLine{34     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} on\_error(\textcolor{keyword}{const} std::exception\_ptr\&)\textcolor{keyword}{ const }\{\}}
\DoxyCodeLine{35     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} on\_unsubscribe()\textcolor{keyword}{ const }\{  \}}
\DoxyCodeLine{36     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} on\_completed()\textcolor{keyword}{ const }\{\}}
\DoxyCodeLine{37 \};}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{40 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1states_1_1error}{error}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}}<T>}
\DoxyCodeLine{41 \{}
\DoxyCodeLine{42 \textcolor{keyword}{public}:}
\DoxyCodeLine{43     \mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1states_1_1error}{error}}(\textcolor{keyword}{const} std::exception\_ptr\& err)}
\DoxyCodeLine{44         : m\_err\{err\} \{\}}
\DoxyCodeLine{45 }
\DoxyCodeLine{46     std::shared\_ptr<const state\_interface<T>> on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub)\textcolor{keyword}{ const override}}
\DoxyCodeLine{47 \textcolor{keyword}{    }\{}
\DoxyCodeLine{48         sub.\mbox{\hyperlink{classrpp_1_1details_1_1subscriber__base_ae9532294156f8acf86d1cf39d4c1cc15}{on\_error}}(m\_err);}
\DoxyCodeLine{49         \textcolor{keywordflow}{return} this-\/>shared\_from\_this();}
\DoxyCodeLine{50     \}}
\DoxyCodeLine{51 }
\DoxyCodeLine{52 \textcolor{keyword}{private}:}
\DoxyCodeLine{53     \textcolor{keyword}{const} std::exception\_ptr m\_err;}
\DoxyCodeLine{54 \};}
\DoxyCodeLine{55 }
\DoxyCodeLine{56 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{57 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1completed}{completed}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}}<T>}
\DoxyCodeLine{58 \{}
\DoxyCodeLine{59     std::shared\_ptr<const state\_interface<T>> on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub)\textcolor{keyword}{ const override}}
\DoxyCodeLine{60 \textcolor{keyword}{    }\{}
\DoxyCodeLine{61         sub.\mbox{\hyperlink{classrpp_1_1details_1_1subscriber__base_a85ef4e79f7f9d82d5899dc2524a7289a}{on\_completed}}();}
\DoxyCodeLine{62         \textcolor{keywordflow}{return} this-\/>shared\_from\_this();}
\DoxyCodeLine{63     \}}
\DoxyCodeLine{64 }
\DoxyCodeLine{65     \textcolor{keyword}{static} \textcolor{keyword}{auto} make()}
\DoxyCodeLine{66     \{}
\DoxyCodeLine{67         \textcolor{keyword}{static} std::shared\_ptr<completed> result = std::make\_shared<completed>();}
\DoxyCodeLine{68         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{69     \}}
\DoxyCodeLine{70 \};}
\DoxyCodeLine{71 }
\DoxyCodeLine{72 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{73 \textcolor{keyword}{struct }\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1unsubscribed}{unsubscribed}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}}<T>}
\DoxyCodeLine{74 \{}
\DoxyCodeLine{75     std::shared\_ptr<const state\_interface<T>> on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub)\textcolor{keyword}{ const override}}
\DoxyCodeLine{76 \textcolor{keyword}{    }\{}
\DoxyCodeLine{77         sub.unsubscribe();}
\DoxyCodeLine{78         \textcolor{keywordflow}{return} this-\/>shared\_from\_this();}
\DoxyCodeLine{79     \}}
\DoxyCodeLine{80 }
\DoxyCodeLine{81     \textcolor{keyword}{static} \textcolor{keyword}{auto} make()}
\DoxyCodeLine{82     \{}
\DoxyCodeLine{83         \textcolor{keyword}{static} std::shared\_ptr<unsubscribed> result = std::make\_shared<unsubscribed>();}
\DoxyCodeLine{84         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{85     \}}
\DoxyCodeLine{86 \};}
\DoxyCodeLine{87 }
\DoxyCodeLine{88 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{89 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1states_1_1active}{active}} final : \textcolor{keyword}{public} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{state\_interface}}<T>}
\DoxyCodeLine{90 \{}
\DoxyCodeLine{91 \textcolor{keyword}{public}:}
\DoxyCodeLine{92     \mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1states_1_1active}{active}}(std::vector<\mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}>\&\& subs = \{\})}
\DoxyCodeLine{93         : m\_subs\{std::move(subs)\} \{\}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95     \textcolor{keywordtype}{bool} is\_terminated()\textcolor{keyword}{ const override }\{ \textcolor{keywordflow}{return} \textcolor{keyword}{false}; \}}
\DoxyCodeLine{96 }
\DoxyCodeLine{97     std::shared\_ptr<const state\_interface<T>> on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub)\textcolor{keyword}{ const override}}
\DoxyCodeLine{98 \textcolor{keyword}{    }\{}
\DoxyCodeLine{99         \textcolor{keyword}{auto} subs = make\_copy\_of\_subscribed\_subs(m\_subs.size() + 1);}
\DoxyCodeLine{100         subs.push\_back(sub);}
\DoxyCodeLine{101         \textcolor{keywordflow}{return} std::make\_shared<active>(std::move(subs));}
\DoxyCodeLine{102     \}}
\DoxyCodeLine{103 }
\DoxyCodeLine{104     std::shared\_ptr<const state\_interface<T>> on\_subscriber\_unsubscribed()\textcolor{keyword}{ const override}}
\DoxyCodeLine{105 \textcolor{keyword}{    }\{}
\DoxyCodeLine{106         \textcolor{keywordflow}{if} (m\_subs.empty())}
\DoxyCodeLine{107             \textcolor{keywordflow}{return} this-\/>shared\_from\_this();}
\DoxyCodeLine{108 }
\DoxyCodeLine{109         \textcolor{keywordflow}{return} std::make\_shared<active>(make\_copy\_of\_subscribed\_subs(m\_subs.size() -\/ 1));}
\DoxyCodeLine{110     \}}
\DoxyCodeLine{111 }
\DoxyCodeLine{112     \textcolor{keywordtype}{void} on\_next(\textcolor{keyword}{const} T\& v)\textcolor{keyword}{ const override}}
\DoxyCodeLine{113 \textcolor{keyword}{    }\{}
\DoxyCodeLine{114         std::ranges::for\_each(m\_subs, [\&](\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub) \{sub.on\_next(v); \});}
\DoxyCodeLine{115     \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117     \textcolor{keywordtype}{void} on\_error(\textcolor{keyword}{const} std::exception\_ptr\& err)\textcolor{keyword}{ const override}}
\DoxyCodeLine{118 \textcolor{keyword}{    }\{}
\DoxyCodeLine{119         std::ranges::for\_each(m\_subs, [\&](\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}}\& sub) \{sub.\mbox{\hyperlink{classrpp_1_1details_1_1subscriber__base_ae9532294156f8acf86d1cf39d4c1cc15}{on\_error}}(err); \});}
\DoxyCodeLine{120     \}}
\DoxyCodeLine{121 }
\DoxyCodeLine{122     \textcolor{keywordtype}{void} on\_completed()\textcolor{keyword}{ const override}}
\DoxyCodeLine{123 \textcolor{keyword}{    }\{}
\DoxyCodeLine{124         std::ranges::for\_each(m\_subs, std::mem\_fn(\&\mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>::on\_completed}}));}
\DoxyCodeLine{125     \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127     \textcolor{keywordtype}{void} on\_unsubscribe()\textcolor{keyword}{ const override}}
\DoxyCodeLine{128 \textcolor{keyword}{    }\{}
\DoxyCodeLine{129         std::ranges::for\_each(m\_subs, std::mem\_fn(\&\mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>::unsubscribe}}));}
\DoxyCodeLine{130     \}}
\DoxyCodeLine{131 }
\DoxyCodeLine{132 \textcolor{keyword}{private}:}
\DoxyCodeLine{133     std::vector<dynamic\_subscriber<T>> make\_copy\_of\_subscribed\_subs(\textcolor{keywordtype}{size\_t} expected\_size)\textcolor{keyword}{ const}}
\DoxyCodeLine{134 \textcolor{keyword}{    }\{}
\DoxyCodeLine{135         std::vector<dynamic\_subscriber<T>> subs\{\};}
\DoxyCodeLine{136         subs.reserve(expected\_size);}
\DoxyCodeLine{137         std::ranges::copy\_if(m\_subs, std::back\_inserter(subs), std::mem\_fn(\&\mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>::is\_subscribed}}));}
\DoxyCodeLine{138         \textcolor{keywordflow}{return} subs;}
\DoxyCodeLine{139     \}}
\DoxyCodeLine{140 }
\DoxyCodeLine{141 \textcolor{keyword}{private}:}
\DoxyCodeLine{142     \textcolor{keyword}{const} std::vector<dynamic\_subscriber<T>> m\_subs\{\};}
\DoxyCodeLine{143 \};}
\DoxyCodeLine{144 \} \textcolor{comment}{// namespace rpp::subjects::details::states}}
\DoxyCodeLine{145 }
\DoxyCodeLine{146 \textcolor{keyword}{namespace }rpp::subjects::details}
\DoxyCodeLine{147 \{}
\DoxyCodeLine{148 \textcolor{keyword}{template}<constra\textcolor{keywordtype}{int}::decayed\_type T>}
\DoxyCodeLine{149 \textcolor{keyword}{class }\mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1subject__state}{subject\_state}} : \textcolor{keyword}{public} std::enable\_shared\_from\_this<subject\_state<T>>}
\DoxyCodeLine{150 \{}
\DoxyCodeLine{151 \textcolor{keyword}{public}:}
\DoxyCodeLine{152     \textcolor{keyword}{using} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{subscriber}} = \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{dynamic\_subscriber<T>}};}
\DoxyCodeLine{153 }
\DoxyCodeLine{154     \mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1subject__state}{subject\_state}}() = \textcolor{keywordflow}{default};}
\DoxyCodeLine{155 }
\DoxyCodeLine{156     \textcolor{keywordtype}{void} on\_subscribe(\textcolor{keyword}{const} \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{subscriber}}\& \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{subscriber}})}
\DoxyCodeLine{157     \{}
\DoxyCodeLine{158         \textcolor{keywordflow}{while} (\textcolor{keyword}{true})}
\DoxyCodeLine{159         \{}
\DoxyCodeLine{160             \textcolor{keyword}{auto} current\_state = std::atomic\_load(\&m\_state);}
\DoxyCodeLine{161             \textcolor{keyword}{auto} new\_state     = current\_state-\/>on\_subscribe(\mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{subscriber}});}
\DoxyCodeLine{162             \textcolor{keywordflow}{if} (current\_state == new\_state)}
\DoxyCodeLine{163                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{164 }
\DoxyCodeLine{165             \textcolor{keywordflow}{if} (std::atomic\_compare\_exchange\_strong(\&m\_state, \&current\_state, new\_state))}
\DoxyCodeLine{166             \{}
\DoxyCodeLine{167                 \textcolor{keyword}{auto} weak = this-\/>weak\_from\_this();}
\DoxyCodeLine{168                 \mbox{\hyperlink{classrpp_1_1dynamic__subscriber}{subscriber}}.get\_subscription().\mbox{\hyperlink{classrpp_1_1composite__subscription_a7fddaca7e9bfe0e7cdf23e477770fd8a}{add}}([weak]}
\DoxyCodeLine{169                 \{}
\DoxyCodeLine{170                     \textcolor{keywordflow}{while} (\textcolor{keyword}{auto} shared = weak.lock())}
\DoxyCodeLine{171                     \{}
\DoxyCodeLine{172                         if (shared-\/>try\_to\_update\_state(\&states::state\_interface<T>::on\_subscriber\_unsubscribed))}
\DoxyCodeLine{173                             return;}
\DoxyCodeLine{174                     \}}
\DoxyCodeLine{175                 \});}
\DoxyCodeLine{176                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{177             \}}
\DoxyCodeLine{178         \}}
\DoxyCodeLine{179     \}}
\DoxyCodeLine{180 }
\DoxyCodeLine{181     \textcolor{keywordtype}{void} on\_next(\textcolor{keyword}{const} T\& v)}
\DoxyCodeLine{182     \{}
\DoxyCodeLine{183         std::atomic\_load(\&m\_state)-\/>on\_next(v);}
\DoxyCodeLine{184     \}}
\DoxyCodeLine{185 }
\DoxyCodeLine{186     \textcolor{keywordtype}{void} on\_error(\textcolor{keyword}{const} std::exception\_ptr\& err)}
\DoxyCodeLine{187     \{}
\DoxyCodeLine{188         update\_state\_if\_not\_terminated(std::make\_shared<\mbox{\hyperlink{classrpp_1_1subjects_1_1details_1_1states_1_1error}{states::error<T>}}>(err), [\&](\textcolor{keyword}{const} \textcolor{keyword}{auto}\& state) \{ state-\/>on\_error(err); \});}
\DoxyCodeLine{189     \}}
\DoxyCodeLine{190 }
\DoxyCodeLine{191     \textcolor{keywordtype}{void} on\_completed()}
\DoxyCodeLine{192     \{}
\DoxyCodeLine{193         update\_state\_if\_not\_terminated(\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1completed}{states::completed<T>::make}}(), \&\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>::on\_completed}});}
\DoxyCodeLine{194     \}}
\DoxyCodeLine{195 }
\DoxyCodeLine{196     \textcolor{keywordtype}{void} on\_unsubscribe()}
\DoxyCodeLine{197     \{}
\DoxyCodeLine{198         update\_state\_if\_not\_terminated(\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1unsubscribed}{states::unsubscribed<T>::make}}(), \&\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>::on\_unsubscribe}});}
\DoxyCodeLine{199     \}}
\DoxyCodeLine{200 }
\DoxyCodeLine{201 \textcolor{keyword}{private}:}
\DoxyCodeLine{202     \textcolor{keyword}{using} state\_interface\_transition\_fn = std::shared\_ptr<const states::state\_interface<T>>(\mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>}}::*)() \textcolor{keyword}{const};}
\DoxyCodeLine{203     \textcolor{keywordtype}{bool} try\_to\_update\_state(state\_interface\_transition\_fn \textcolor{keyword}{function})}
\DoxyCodeLine{204     \{}
\DoxyCodeLine{205         \textcolor{keyword}{auto} current\_state = std::atomic\_load(\&m\_state);}
\DoxyCodeLine{206         \textcolor{keyword}{auto} new\_state = std::invoke(\textcolor{keyword}{function}, current\_state);}
\DoxyCodeLine{207 }
\DoxyCodeLine{208         \textcolor{keywordflow}{return} try\_to\_update\_state(current\_state, new\_state);}
\DoxyCodeLine{209     \}}
\DoxyCodeLine{210 }
\DoxyCodeLine{211     \textcolor{keywordtype}{bool} try\_to\_update\_state(std::shared\_ptr<\textcolor{keyword}{const} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>}}> old, std::shared\_ptr<\textcolor{keyword}{const} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>}}> new\_state)}
\DoxyCodeLine{212     \{}
\DoxyCodeLine{213         \textcolor{keywordflow}{return} old == new\_state || std::atomic\_compare\_exchange\_strong(\&m\_state, \&old, new\_state);}
\DoxyCodeLine{214     \}}
\DoxyCodeLine{215 }
\DoxyCodeLine{216     \textcolor{keywordtype}{void} update\_state\_if\_not\_terminated(std::shared\_ptr<\textcolor{keyword}{const} \mbox{\hyperlink{structrpp_1_1subjects_1_1details_1_1states_1_1state__interface}{states::state\_interface<T>}}> new\_state, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& state\_callback)}
\DoxyCodeLine{217     \{}
\DoxyCodeLine{218         \textcolor{keywordflow}{while} (\textcolor{keyword}{true})}
\DoxyCodeLine{219         \{}
\DoxyCodeLine{220             \textcolor{keyword}{auto} current\_state = std::atomic\_load(\&m\_state);}
\DoxyCodeLine{221             \textcolor{keywordflow}{if} (current\_state-\/>is\_terminated())}
\DoxyCodeLine{222                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{223 }
\DoxyCodeLine{224             \textcolor{keywordflow}{if} (try\_to\_update\_state(current\_state, new\_state))}
\DoxyCodeLine{225             \{}
\DoxyCodeLine{226                 std::invoke(state\_callback, current\_state);}
\DoxyCodeLine{227                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{228             \}}
\DoxyCodeLine{229         \}}
\DoxyCodeLine{230     \}}
\DoxyCodeLine{231 }
\DoxyCodeLine{232 \textcolor{keyword}{private}:}
\DoxyCodeLine{233     utils::atomic\_shared\_ptr<const states::state\_interface<T>> m\_state = std::make\_shared<states::active<T>>();}
\DoxyCodeLine{234 \};}
\DoxyCodeLine{235 \} \textcolor{comment}{// namespace rpp::subjects::details}}

\end{DoxyCode}
